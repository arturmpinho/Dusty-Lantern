{% extends 'base.html' %}
{% load static %}

{% block content %}

    {% include 'components/navigation/navbar.html' %}
    
    <div class="pt-5 mt-5 rounded-3">
        <div class="container-fluid py-5 mt-5">
            <h2>Ongoing Auctions</h2>
            <hr>
        </div>
    </div>
    
    <!-- Category filter nav -->
    <div class="container text-center mb-5">
      <ul class="nav justify-content-center">

        {% for category in categories %}
          <li class="nav-item">
            <a class="nav-link category-filter" href="{% url 'auctions' %}?category={{category}}"><i class="{{ category.fa_icon_class}}"></i> {{category.friendly_name}}</a>
          </li>
        {% endfor %}

      </ul>
      <select id="sort-selector">
        <option value="reset" {% if sorting == 'None_None' %}selected{% endif %}>Sorty by...</option>
        <option value="base_amount,asc" {% if sorting == 'base_amount_asc' %}selected{% endif %}>Base Amount: Low to High</option>
        <option value="base_amount,desc" {% if sorting == 'base_amount_desc' %}selected{% endif %}>Base Amount: High to Low</option>
        <option value="product__category,asc" {% if sorting == 'product__category_asc' %}selected{% endif %}>Category (A-Z)</option>
        <option value="product__category,desc" {% if sorting == 'product__category_desc' %}selected{% endif %}>Category (Z-A)</option>
        <option value="product__condition,asc" {% if sorting == 'product__condition_asc' %}selected{% endif %}>Condition (New-To Be Fixed)</option>
        <option value="product__condition,desc" {% if sorting == 'product__condition_desc' %}selected{% endif %}>Condition (To Be Fixed-New) </option>
        <option value="end_date_time,asc" {% if sorting == 'end_date_time_asc' %}selected{% endif %}>First closing</option>
        <option value="end_date_time,desc" {% if sorting == 'end_date_time_desc' %}selected{% endif %}>Last Closing</option>
      </select>
    </div>
    <div class="container text-center">
      <p>
        <a class="btn btn-outline-danger" href="{% url 'auctions' %}"></i>Clear filters</a>
      </p>
    </div>
    <div class="container text-center">
      <p>
        <span id="cards-counter"></span>
      </p>
    </div>

    <!-- Auction Cards -->
    <div class="row row-cols-1 row-cols-md-2 g-4">
      {% for auction in auctions %}
        {% if request.user.is_superuser %}
          <div class="col col-md-4 col-lg-3">
            <div class="card">
              <div class="card-body">

                {% for image in auction.product.images.all %}
                {% if image.main_image %}
                <img class = "card-img-top" src="{{image.image.url}}" alt="{{ product.title }}">
                {% endif %}
                {% endfor %}

                <hr>
                <p class="text-end">
                  <span class="badge bg-secondary">{{ auction.product.category }}</span>
                  <span class="badge bg-secondary">{{ auction.product.condition.friendly_description}}</span>
                  <a href="#"><i class="far fa-star fa-2x nav-link"></i></a>
                </p>
                <h2 class="card-title">{{ auction.product.title }} | {{ auction.product.brand }}</h2>
                <p class="card-text">{{ auction.product.description}}</p>
                <p><i class="far fa-money-bill-alt fa-2x"></i> € {{ auction.base_amount }}</p>
                      
                  {% for bid in no_bids %}
                    {% if bid == auction %}
                      <p>No bids yet</p>
                    {% endif %}
                  {% endfor %}

                  {% for bid in highest_bids %}
                      {% if bid.auction == auction %}
                      
                        <p><i class="fas fa-gavel fa-2x"></i>€ {{ bid.bid }}</p>
                        <p><i class="fas fa-user fa-2x"></i> Last bid from: {{ bid.bidder }} </p>
                      {% endif %}
                  {% endfor %}

                <div class="start_date_time" hidden>{{ auction.start_date_time|date:"Y-m-d H:m:s" }} </div>
                <div class="end_date_time" hidden>{{ auction.end_date_time|date:"Y-m-d H:m:s" }} </div>

                {% if current_date_time >= auction.start_date_time|date:"Y-m-d H:m:s" %}
                <p><i class="far fa-clock fa-2x"></i> <span class="countdowntimer"></span></p>
                {% elif auction.start_date_time|date:"Y-m-d H:m:s" > current_date_time %}
                  <p>
                    <i class="far fa-clock fa-2x"></i> 
                    <span class="countdowntimer"></span>
                  </p>
                {% else %}
                  <p>
                    <i class="far fa-clock fa-2x"></i> 
                    <span class="countdowntimer"></span> 
                  </p>
                {% endif %}

                <!-- Card footer -->
                </div>
                <div class="card-footer">
                    <a href="{% url 'auction_detail' auction.id %}" class="btn btn-outline-danger">See details</a>
                </div>
              </div>
          </div>
        {% else %}
          {% now "Y-m-d H:m:s" as current_date_time %}
          {% if current_date_time < auction.end_date_time|date:"Y-m-d H:m:s" %}
            <div class="col col-md-4 col-lg-3">
              <div class="card">
                <div class="card-body">

                  {% for image in auction.product.images.all %}
                  {% if image.main_image %}
                  <img class = "card-img-top" src="{{image.image.url}}" alt="{{ product.title }}">
                  {% endif %}
                  {% endfor %}

                  <hr>
                  <p class="text-end">
                    <span class="badge bg-secondary">{{ auction.product.category }}</span>
                    <span class="badge bg-secondary">{{ auction.product.condition.friendly_description}}</span>
                    <a href="#"><i class="far fa-star fa-2x nav-link"></i></a>
                  </p>
                  <h2 class="card-title">{{ auction.product.title }} | {{ auction.product.brand }}</h2>
                  <p class="card-text">{{ auction.product.description}}</p>
                  <p><i class="far fa-money-bill-alt fa-2x"></i> € {{ auction.base_amount }}</p>
                        
                    {% for bid in no_bids %}
                      {% if bid == auction %}
                        <p>No bids yet</p>
                      {% endif %}
                    {% endfor %}

                    {% for bid in highest_bids %}
                        {% if bid.auction == auction %}
                        
                          <p><i class="fas fa-gavel fa-2x"></i>€ {{ bid.bid }}</p>
                          <p><i class="fas fa-user fa-2x"></i> Last bid from: {{ bid.bidder }} </p>
                        {% endif %}
                    {% endfor %}

                  <div class="start_date_time" hidden>{{ auction.start_date_time|date:"Y-m-d H:m:s" }} </div>
                  <div class="end_date_time" hidden>{{ auction.end_date_time|date:"Y-m-d H:m:s" }} </div>

                  {% if current_date_time >= auction.start_date_time|date:"Y-m-d H:m:s" %}
                  <p><i class="far fa-clock fa-2x"></i> <span class="countdowntimer"></span></p>
                  {% elif auction.start_date_time|date:"Y-m-d H:m:s" > current_date_time %}
                    <p>
                      <i class="far fa-clock fa-2x"></i> 
                      <span class="countdowntimer"></span>
                    </p>
                  {% else %}
                    <p>
                      <i class="far fa-clock fa-2x"></i> 
                      <span class="countdowntimer"></span> 
                    </p>
                  {% endif %}

                  <!-- Card footer -->
                  </div>
                  <div class="card-footer">
                      <a href="{% url 'auction_detail' auction.id %}" class="btn btn-outline-danger">See details</a>
                  </div>
              </div>
            </div>
          {% endif %}
        {% endif %}
      {% endfor %}
    </div>

{% endblock%}

{% block postloadjs %}
  {{ block.super }}
  <script src="{% static 'js/auctions.js' %}"></script>
{% endblock %}